<!doctype html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>বাংলাদেশ নির্বাচন কমিশন — Login</title>
  <style>
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:"Noto Sans Bengali","Noto Sans",Arial,sans-serif;background:#f6faf8;color:#0b3a2e}
    :root{--green-600:#0b6a33; --green-400:#2fa14f;}

    /* background / layout */
    .page-bg{position:fixed;inset:0;background-image:url('images/Bangladesh_EC.jpg');background-size:cover;background-position:center 300px;filter:blur(2px) brightness(0.95);z-index:0}
    .topbar{position:relative;z-index:3;background:rgba(255,255,255,0.97);border-bottom:1px solid rgba(6,60,30,0.06)}
    .topbar-inner{max-width:1200px;margin:0 auto;padding:10px 18px;display:flex;align-items:center;justify-content:space-between}
    .brand-left{display:flex;gap:12px;align-items:center}
    .logo-small{width:56px;height:56px;object-fit:contain}
    .org-name{font-size:18px;font-weight:800;color:var(--green-600)}
    .org-sub{font-size:13px;font-weight:700;color:#0b4f33;margin-top:2px}
    .topbar-right{display:flex;align-items:center;gap:14px;font-size:14px}
    .helpline{padding:6px 10px;border-radius:8px;border:1px solid rgba(11,79,49,0.06);color:var(--green-600);font-weight:700}

    .wrap{position:relative;z-index:2;max-width:1200px;margin:30px auto;padding:20px;display:flex;gap:28px;align-items:center;justify-content:center}
    .login-card{width:520px;border-radius:16px;background:linear-gradient(180deg,#fff,#fbfffb);padding:28px;box-shadow:0 28px 70px rgba(6,60,30,0.12);border:1px solid rgba(6,60,30,0.06)}

    .card-title{text-align:center;font-size:22px;font-weight:800;color:var(--green-600)}
    .card-sub{text-align:center;margin:10px 0 20px;color:#50645a}
    .role-tabs{display:flex;gap:8px;justify-content:center;margin:10px 0 20px;flex-wrap:wrap}
    .role-item{padding:10px 16px;border-radius:12px;background:transparent;color:var(--green-600);border:2px solid transparent;font-weight:700;cursor:pointer}
    .role-item.active{background:linear-gradient(180deg,var(--green-400),var(--green-600));color:#fff;box-shadow:0 8px 24px rgba(11,79,49,0.14)}
    .field-label{margin-bottom:8px;color:#31493e}
    input{width:100%;padding:14px 16px;font-size:16px;border:1px solid #e6efe8;border-radius:10px;background:#fbfffb;outline:none}
    input:focus{border-color:var(--green-600);box-shadow:0 10px 30px rgba(11,79,49,0.06)}
    .captcha-row{display:flex;gap:12px;margin-top:12px}
    canvas.captcha-canvas{width:160px;height:48px;border-radius:6px;border:1px solid #dfe9e0;background:#fff}
    .captcha-controls{display:flex;flex-direction:column;gap:6px}
    .link-small{color:var(--green-600);font-size:13px;cursor:pointer;text-decoration:none}
    .form-actions{margin-top:16px}
    .btn-primary{width:100%;padding:14px;border-radius:12px;background:linear-gradient(180deg,var(--green-400),var(--green-600));color:#fff;font-weight:800;font-size:17px;border:none;cursor:pointer}

    .error{display:none;background:#fdecea;color:#8a1b13;padding:10px;border-radius:10px;border:1px solid #f2c6c6;margin-bottom:12px}
    .muted{color:#587a6a;font-size:13px}
    .otp-area{margin-top:12px;padding-top:8px;border-top:1px dashed #e6efe8}
    .otp-input{display:flex;gap:8px;align-items:center}
    .otp-input input{flex:1}
    .small-btn{background:transparent;border:none;color:var(--green-600);cursor:pointer;font-weight:700}
    .countdown{font-weight:700;color:#2f7b45}
    .success{background:#e6f7ec;color:#0b6a33;padding:12px;border-radius:10px;margin-top:12px;border:1px solid rgba(11,79,49,0.08)}
    .page-footer{text-align:center;padding:18px;color:#385342;margin-top:20px}

    /* ===== Modal + overlay for Verified popup ===== */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.28);
      backdrop-filter: blur(6px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .modal {
      background: #fff;
      border-radius: 14px;
      padding: 28px 32px;
      min-width: 320px;
      max-width: 520px;
      box-shadow: 0 20px 60px rgba(6,60,30,0.2);
      text-align:center;
      transform-origin:center;
    }
    .modal .tick {
      width:86px;height:86px;border-radius:50%;background:linear-gradient(180deg,#2fa14f,#0b6a33);display:inline-flex;align-items:center;justify-content:center;color:#fff;font-size:44px;margin-bottom:12px;box-shadow:0 8px 20px rgba(11,79,49,0.18);
    }
    .modal h2{margin:6px 0 6px;font-size:22px;color:#0b6a33}
    .modal p{color:#425b4f;margin:8px 0 0}

    /* show overlay */
    .overlay.show { display:flex; }

    @media(max-width:980px){.wrap{flex-direction:column}.login-card{width:100%}}
  </style>
</head>
<body>
  <div class="page-bg"></div>

  <header class="topbar" role="banner">
    <div class="topbar-inner">
      <div class="brand-left">
        <img src="images/1123.jpg" class="logo-small" alt="logo">
        <div>
          <div class="org-name">বাংলাদেশ নির্বাচন কমিশন</div>
          <div class="org-sub">Bangladesh Election Commission</div>
        </div>
      </div>
      <div class="topbar-right">
        <div class="helpline">Helpline: <strong>+880-1316-448433</strong></div>
        <div class="support">Support: <a href="mailto:support@bec.gov.bd" style="color:var(--green-600);font-weight:700;">support@bec.gov.bd</a></div>
        <!-- Sign-Up now points to signup.html -->
        <a href="signup.html" class="helpline" style="background:#fff;border:1px solid rgba(11,79,49,0.12);text-decoration:none;color:var(--green-600);font-weight:700;padding:6px 10px;border-radius:8px;">Sign-Up</a>
      </div>
    </div>
  </header>

  <main class="wrap" role="main">
    <section class="login-card" aria-labelledby="loginTitle">
      <h1 id="loginTitle" class="card-title">Login</h1>
      <div class="card-sub">Do not have an account? <a href="signup.html" style="color:var(--green-600);font-weight:800">Sign-Up</a></div>

      <div id="error" class="error" role="alert"></div>

      <div class="role-tabs" role="tablist" aria-label="Login Role">
        <button class="role-item active" data-role="voter" onclick="selectRole(event)">Voter</button>
        <button class="role-item" data-role="candidate" onclick="selectRole(event)">Candidate</button>
        <button class="role-item" data-role="admin" onclick="selectRole(event)">Admin</button>
        <button class="role-item" data-role="guest" onclick="selectRole(event)">Guest</button>
      </div>

      <!-- initial login form -->
      <form id="loginForm" autocomplete="off" onsubmit="return requestOTP(event)">
        <div>
          <label class="field-label">Registered Mobile No. / Email / ID</label>
          <input id="phone" placeholder="+8801xxxxxxxxx" aria-label="phone or email or id">
        </div>

        <div class="captcha-row" aria-hidden="false">
          <canvas id="captchaCanvas" class="captcha-canvas" width="160" height="48"></canvas>
          <div class="captcha-controls">
            <a class="link-small" onclick="regenCaptcha()">Refresh</a>
            <a class="link-small" onclick="playCaptcha()">Play</a>
            <a class="link-small" onclick="copyCaptcha()">Copy</a>
          </div>
        </div>

        <div style="margin-top:12px">
          <label class="field-label">Captcha</label>
          <input id="captchaInput" placeholder="Enter Captcha" aria-label="captcha input">
        </div>

        <div class="form-actions">
          <button id="requestBtn" class="btn-primary">Request OTP</button>
        </div>

        <!-- OTP area (hidden initially) -->
        <div id="otpArea" class="otp-area" style="display:none">
          <div class="muted" id="otpInfo">OTP পাঠানো হয়েছে <span id="maskedPhone"></span>. কোডটি ৬ অঙ্কের — ৬০ সেকেন্ডের মধ্যে বসাও।</div>

          <div class="otp-input" style="margin-top:8px">
            <input id="otpInput" placeholder="Enter OTP" aria-label="otp input" />
            <button id="verifyBtn" type="button" class="small-btn" onclick="verifyOTP()">Verify</button>
          </div>

          <div style="display:flex;align-items:center;gap:10px;margin-top:8px">
            <div class="muted">Time left: <span id="countdown" class="countdown">00:60</span></div>
            <button id="resendBtn" type="button" class="small-btn" onclick="resendOTP()" disabled>Resend</button>
            <button id="cancelOtp" type="button" class="small-btn" onclick="cancelOTP()">Cancel</button>
          </div>

          <div id="otpSuccess" class="success" style="display:none">OTP ভেরিফাই সফল — Redirecting...</div>
        </div>
        <!-- ========== DONATE CARD + MODAL (ADD BEFORE footer) ========== -->
<style>
/* Donate card (placed middle-bottom) */
.donate-wrap{display:flex;justify-content:center;margin:18px 0 6px;z-index:5}
.donate-card{background:linear-gradient(180deg,#fff,#f7fffb);border:1px solid rgba(11,79,49,0.06);box-shadow:0 14px 40px rgba(6,60,30,0.06);padding:12px 18px;border-radius:12px;display:flex;gap:12px;align-items:center;max-width:760px;width:92%}
.donate-card .left{font-weight:800;color:var(--green-600);font-size:15px}
.donate-card .right{margin-left:auto;display:flex;gap:10px;align-items:center}
.btn-donate{background:linear-gradient(180deg,var(--green-400),var(--green-600));color:#fff;padding:10px 14px;border-radius:10px;border:none;font-weight:800;cursor:pointer}
.btn-ghost-small{background:transparent;border:1px solid rgba(11,79,49,0.08);padding:8px 10px;border-radius:10px;color:var(--green-600);cursor:pointer;font-weight:700;font-size:13px}

/* Modal */
.dmodal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.36);display:none;align-items:center;justify-content:center;z-index:9999}
.dmodal{width:920px;max-width:96%;background:#fff;border-radius:12px;padding:18px;box-shadow:0 30px 80px rgba(6,60,30,0.18);display:flex;gap:16px}
.dmodal .left-col{flex:1;min-width:260px;border-right:1px solid rgba(6,60,30,0.04);padding-right:12px}
.dmodal .right-col{flex:1;min-width:300px;padding-left:12px}
.dmodal h3{margin:0 0 8px;color:var(--green-600)}
.select, input[type="number"]{width:100%;padding:10px;border-radius:8px;border:1px solid #e6efe8;font-size:15px}
.candidate-item{display:flex;gap:10px;align-items:center;padding:10px;border-radius:10px;border:1px solid transparent;cursor:pointer}
.candidate-item img{width:56px;height:56px;border-radius:8px;object-fit:cover;border:1px solid #e9f3ee}
.candidate-item.selected{background:linear-gradient(180deg,#f2fff6,#ffffff);border-color:rgba(11,79,49,0.08);box-shadow:0 8px 28px rgba(11,79,49,0.06)}
.donate-meta{font-size:14px;color:#345243;margin-bottom:8px}
.donate-actions{display:flex;gap:10px;align-items:center;margin-top:12px}
.don-hist{max-height:220px;overflow:auto;border-top:1px dashed #e6efe8;padding-top:10px;margin-top:10px}
.small-muted{font-size:13px;color:#5a6f62}

/* responsive */
@media(max-width:880px){ .dmodal{flex-direction:column} .dmodal .left-col{border-right:none;padding-right:0} .dmodal .right-col{padding-left:0} }
</style>

<div class="donate-wrap" aria-hidden="false">
  <div class="donate-card" role="region" aria-label="Donate for campaign">
    <div class="left">
      Donate for Election Campaign — Candidate Support (BDT)
      <div class="small-muted" style="font-weight:600;font-size:13px">আপনি পছন্দমত ক্যান্ডিডেটকে অনুদান দিতে পারবেন।</div>
    </div>

    <div class="right">
      <button class="btn-ghost-small" id="viewCandidatesBtn">View Candidates</button>
      <button class="btn-donate" id="openDonateModal">Donate</button>
    </div>
  </div>
</div>

<div id="dmodalOverlay" class="dmodal-overlay" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="dmodal" role="document" aria-label="Donate modal">
    <div class="left-col">
      <h3>Choose Election &amp; Candidate</h3>
      <label class="small-muted">Select Election</label>
      <select id="donationElection" class="select" aria-label="Select election">
        <option value="national">National Parliament Election</option>
        <option value="city">City Corporation Election</option>
        <option value="paurashava">Paurashava Election</option>
        <option value="upazila">Upazila Election</option>
        <option value="zila">Zila Parishad Election</option>
        <option value="union">Union Parishad Election</option>
      </select>

      <div style="margin-top:12px">
        <label class="small-muted">Candidates</label>
        <div id="candidatesList" style="display:flex;flex-direction:column;gap:8px;margin-top:8px" aria-live="polite">
          <!-- candidate items injected by JS -->
        </div>
      </div>

      <div class="don-hist" id="donationHistory">
        <strong>Donation History</strong>
        <div id="donHistList" style="margin-top:8px;font-size:14px;color:#3b5d49">
          <!-- history injected -->
        </div>
      </div>
    </div>

    <div class="right-col">
      <h3>Donate</h3>
      <div class="donate-meta">Selected: <span id="selCandidate">—</span></div>

      <label class="small-muted">Amount (BDT)</label>
      <input id="donAmount" type="number" min="50" placeholder="Enter amount in BDT" />

      <label style="margin-top:8px" class="small-muted">Donor Name (optional)</label>
      <input id="donorName" type="text" placeholder="Your name (প্রয়োজনে)" />

      <div class="donate-actions">
        <button class="btn-donate" id="sendDonateBtn">Send Donation</button>
        <button class="btn-ghost-small" id="closeDonate">Close</button>
      </div>

      <div id="donStatus" style="margin-top:12px;font-weight:700;color:#1f7b45"></div>

      <div style="margin-top:18px;color:#50645a;font-size:13px">
        Note: This is a demo donation UI — payment is simulated. For real payments integrate a gateway (bkash, nagad, card).
      </div>
    </div>
  </div>
</div>


<script>
/* Sample candidates database (editable) */
const CANDIDATES = {
  national: [
    { id:'nat-1', name:'Md Nehal', party:'Independent', photo:'images/c1.jpg' },
    { id:'nat-2', name:'Md Reaz ', party:'Party X', photo:'images/c2.jpg' }
  ],
  city: [
    { id:'city-1', name:'Md Nehal', party:'Party Y', photo:'images/c1.jpg' },
    { id:'city-2', name:'Md Reaz ', party:'Party Z', photo:'images/c2.jpg' }
  ],
  paurashava: [
    { id:'p-1', name:'Md Nehal', party:'Independent', photo:'images/c1.jpg' },
    { id:'p-2', name:'Md Reaz '', party:'Party A', photo:'images/c2.jpg' }
  ],
  upazila:[
    { id:'u-1', name:'Md Nehal', party:'Party B', photo:'images/c1.jpg' },
    { id:'u-2', name:'Md Reaz ', party:'Party C', photo:'images/c2.jpg' }
  ],
  zila:[
    { id:'z-1', name:'Md Nehal', party:'Party D', photo:'images/c1.jpg' },
    { id:'z-2', name:'Md Reaz ', party:'Party E', photo:'images/c2.jpg' }
  ],
  union:[
    { id:'un-1', name:'Md Nehal', party:'Independent', photo:'images/c1.jpg' },
    { id:'un-2', name:'Md Reaz ', party:'Party F', photo:'images/c2.jpg' }
  ]
};


/* small helper: render candidates for selected election */
function renderCandidates(election){
  const wrap = document.getElementById('candidatesList');
  wrap.innerHTML = '';
  const list = CANDIDATES[election] || [];
  list.forEach(c=>{
    const node = document.createElement('div');
    node.className = 'candidate-item';
    node.tabIndex = 0;
    node.dataset.cid = c.id;
    node.innerHTML = `<img src="${c.photo}" alt="${c.name}"><div style="flex:1"><strong style="display:block">${c.name}</strong><div class="small-muted">${c.party}</div></div>`;
    node.addEventListener('click', ()=> selectCandidate(node, c));
    node.addEventListener('keydown', (ev)=> { if(ev.key==='Enter') selectCandidate(node,c); });
    wrap.appendChild(node);
  });
  // auto-select first
  if(list.length) {
    setTimeout(()=> {
      const first = wrap.querySelector('.candidate-item');
      if(first) first.click();
    }, 50);
  } else {
    document.getElementById('selCandidate').textContent = '—';
  }
}

/* select candidate */
let currentSelected = null;
function selectCandidate(node, candidate){
  // clear prev
  document.querySelectorAll('.candidate-item').forEach(n=>n.classList.remove('selected'));
  node.classList.add('selected');
  currentSelected = candidate;
  document.getElementById('selCandidate').textContent = candidate.name + ' · ' + candidate.party;
}

/* open/close modal */
const overlay = document.getElementById('dmodalOverlay');
document.getElementById('openDonateModal').addEventListener('click', ()=> {
  overlay.style.display = 'flex';
  overlay.setAttribute('aria-hidden','false');
  // render default election
  const el = document.getElementById('donationElection').value;
  renderCandidates(el);
  loadDonationHistory();
});
document.getElementById('closeDonate').addEventListener('click', closeDonate);
document.getElementById('viewCandidatesBtn').addEventListener('click', ()=> {
  // open modal focused on candidates
  document.getElementById('openDonateModal').click();
});

/* change election */
document.getElementById('donationElection').addEventListener('change', (e)=>{
  renderCandidates(e.target.value);
});

/* close helper */
function closeDonate(){
  overlay.style.display = 'none';
  overlay.setAttribute('aria-hidden','true');
  currentSelected = null;
  document.getElementById('donAmount').value = '';
  document.getElementById('donorName').value = '';
  document.getElementById('donStatus').textContent = '';
}

/* send donation (simulated) */
document.getElementById('sendDonateBtn').addEventListener('click', ()=> {
  const amountEl = document.getElementById('donAmount');
  const amt = parseFloat(amountEl.value);
  const donor = document.getElementById('donorName').value.trim() || 'Anonymous';
  const statusEl = document.getElementById('donStatus');

  if(!currentSelected){
    statusEl.style.color = '#b12727'; statusEl.textContent = 'প্রথমে একটি ক্যান্ডিডেট সিলেক্ট করুন।'; return;
  }
  if(!amt || amt < 50){ statusEl.style.color = '#b12727'; statusEl.textContent = 'ন্যূনতম ৫০ BDT পাঠাতে হবে।'; return; }

  // save donation to localStorage (simple ledger)
  const key = 'evotee_donations';
  let ledger = JSON.parse(localStorage.getItem(key) || '[]');
  const entry = {
    id: 'don-'+Date.now(),
    candidate_id: currentSelected.id,
    candidate_name: currentSelected.name,
    election: document.getElementById('donationElection').value,
    amount: amt,
    donor: donor,
    ts: new Date().toISOString()
  };
  ledger.unshift(entry);
  localStorage.setItem(key, JSON.stringify(ledger));

  statusEl.style.color = '#0b6a33';
  statusEl.textContent = 'Donation sent (simulated). ধন্যবাদ!';

  // update history
  loadDonationHistory();

  // clear amount
  amountEl.value = '';
});

/* load donation history */
function loadDonationHistory(){
  const key = 'evotee_donations';
  const hist = JSON.parse(localStorage.getItem(key) || '[]');
  const wrap = document.getElementById('donHistList');
  if(!hist.length){ wrap.innerHTML = '<div class="small-muted">কোনো অনুদান দেখা যায়নি।</div>'; return; }
  wrap.innerHTML = '';
  hist.slice(0,10).forEach(h=>{
    const row = document.createElement('div');
    row.style.padding = '8px 0'; row.style.borderBottom = '1px dashed #eef6ee';
    row.innerHTML = `<div style="font-weight:800">${h.candidate_name} <span style="font-weight:700;color:#0b6a33">+${h.amount} BDT</span></div><div class="small-muted">${new Date(h.ts).toLocaleString()}</div>`;
    wrap.appendChild(row);
  });
}

/* close modal on Esc */
document.addEventListener('keydown', (e)=> {
  if(e.key === 'Escape' && overlay.style.display === 'flex') closeDonate();
});
</script>
<!-- ========== END DONATE BLOCK ========== -->

      </form>
    </section>
    
  </main>

  <!-- Overlay + Verified modal -->
  <div id="overlay" class="overlay" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal" role="document" aria-labelledby="modalTitle" aria-describedby="modalDesc">
      <div class="tick">✓</div>
      <h2 id="modalTitle">Verified</h2>
      <p id="modalDesc">আপনার OTP সফলভাবে যাচাই হয়েছে। আপনি এখন ড্যাশবোর্ডে যেতে পারবেন।</p>
      <div style="margin-top:14px">
        <button onclick="closeModal()" style="padding:10px 18px;border-radius:8px;border:none;background:var(--green-600);color:#fff;font-weight:700;cursor:pointer">Continue</button>
      </div>
    </div>
  </div>

  <footer class="page-footer">© <span id="yr"></span> Bangladesh Election Commission</footer>

  <script>
    document.getElementById('yr').textContent = new Date().getFullYear();

    /* role tabs */
    function selectRole(e){
      document.querySelectorAll('.role-item').forEach(b=>b.classList.remove('active'));
      e.currentTarget.classList.add('active');
      document.getElementById('loginForm').dataset.role = e.currentTarget.dataset.role;
    }

    /* CAPTCHA */
    let currentCaptcha = '';
    function genRandomCaptcha(len=6){
      const chars='ABCDEFGHJKLMNPQRSTUVWXYZ23456789abcdefghjkmnpqrstuvwxyz';
      let s=''; for(let i=0;i<len;i++) s+=chars.charAt(Math.floor(Math.random()*chars.length));
      return s;
    }
    function drawCaptcha(text){
      currentCaptcha = text;
      const c=document.getElementById('captchaCanvas'), ctx=c.getContext('2d');
      ctx.clearRect(0,0,c.width,c.height);
      ctx.fillStyle='#fff'; ctx.fillRect(0,0,c.width,c.height);
      for(let i=0;i<4;i++){ ctx.strokeStyle='rgba(11,79,49,0.12)'; ctx.beginPath(); ctx.moveTo(Math.random()*c.width,Math.random()*c.height); ctx.lineTo(Math.random()*c.width,Math.random()*c.height); ctx.stroke(); }
      const baseX=12;
      for(let i=0;i<text.length;i++){
        ctx.save(); ctx.translate(baseX+i*22,26); ctx.rotate((Math.random()*20-10)*Math.PI/180);
        ctx.font=(22+Math.random()*4)+'px Arial';
        ctx.fillStyle=(i%2===0)?'#0b6a33':'#145c32';
        ctx.fillText(text[i],0,0); ctx.restore();
      }
    }
    function regenCaptcha(){ drawCaptcha(genRandomCaptcha()); document.getElementById('captchaInput').value=''; }
    function playCaptcha(){ if(!('speechSynthesis' in window)){ alert('Audio not supported'); return; } const ut=new SpeechSynthesisUtterance(currentCaptcha.split('').join(' ')); ut.lang='en-US'; speechSynthesis.cancel(); speechSynthesis.speak(ut); }
    function copyCaptcha(){ navigator.clipboard?.writeText(currentCaptcha).then(()=>alert('Copied')); }

    /* OTP logic (client-side simulation) */
    let simulatedOTP = null;
    let otpTimer = null;
    let timeLeft = 0;
    let resendCount = 0;
    const RESEND_LIMIT = 3;

    function maskPhone(phone){
      if(!phone) return '';
      const digits = phone.replace(/\s+/g,'');
      if(digits.length <= 4) return digits;
      const last4 = digits.slice(-4);
      return '••••' + last4;
    }

    function requestOTP(e){
      e.preventDefault();
      const phone = document.getElementById('phone').value.trim();
      const cap = document.getElementById('captchaInput').value.trim();
      const err = document.getElementById('error');
      err.style.display='none';

      if(phone.length < 7){ err.style.display='block'; err.textContent='সঠিক ফোন/ইমেইল/আইডি লিখুন।'; return false; }
      if(cap.length < 1){ err.style.display='block'; err.textContent='Captcha লিখুন।'; return false; }
      if(cap !== currentCaptcha){ err.style.display='block'; err.textContent='ভুল Captcha — Refresh করুন।'; regenCaptcha(); return false; }

      // simulate sending OTP
      simulatedOTP = String(Math.floor(100000 + Math.random()*900000));
      console.log('SIMULATED OTP =', simulatedOTP); // dev only

      // show OTP area
      document.getElementById('otpArea').style.display = 'block';
      document.getElementById('maskedPhone').textContent = maskPhone(phone);
      document.getElementById('otpInput').value = '';
      document.getElementById('otpSuccess').style.display = 'none';
      document.getElementById('resendBtn').disabled = true;

      // start timer (60s)
      startOTPTimer(60);

      // disable request button to prevent double
      document.getElementById('requestBtn').disabled = true;
      document.getElementById('requestBtn').textContent = 'OTP Sent';
      return false;
    }

    function startOTPTimer(seconds){
      clearInterval(otpTimer);
      timeLeft = seconds;
      updateCountdown();
      otpTimer = setInterval(()=> {
        timeLeft--;
        updateCountdown();
        if(timeLeft <= 0){
          clearInterval(otpTimer);
          document.getElementById('resendBtn').disabled = (resendCount >= RESEND_LIMIT);
          document.getElementById('countdown').textContent = '00:00';
        }
      }, 1000);
    }

    function updateCountdown(){
      const mm = Math.floor(timeLeft/60).toString().padStart(2,'0');
      const ss = (timeLeft%60).toString().padStart(2,'0');
      document.getElementById('countdown').textContent = mm+':'+ss;
    }

    function resendOTP(){
      if(resendCount >= RESEND_LIMIT){ alert('Resend limit reached'); return; }
      resendCount++;
      simulatedOTP = String(Math.floor(100000 + Math.random()*900000));
      console.log('RESEND SIMULATED OTP =', simulatedOTP);
      startOTPTimer(60);
      document.getElementById('resendBtn').disabled = true;
      alert('নতুন OTP পাঠানো (সিমুলেট)।');
    }

    function cancelOTP(){
      clearInterval(otpTimer);
      simulatedOTP = null;
      document.getElementById('otpArea').style.display = 'none';
      document.getElementById('requestBtn').disabled = false;
      document.getElementById('requestBtn').textContent = 'Request OTP';
      document.getElementById('otpInput').value = '';
      document.getElementById('error').style.display = 'none';
    }

    /* ===== VERIFIED modal control ===== */
    function openModal(){
      const ov = document.getElementById('overlay');
      ov.classList.add('show');
      ov.setAttribute('aria-hidden','false');
      // prevent scrolling
      document.body.style.overflow = 'hidden';
    }
    function closeModal(){
  const ov = document.getElementById('overlay');
  ov.classList.remove('show');
  ov.setAttribute('aria-hidden','true');
  document.body.style.overflow = '';

  // detect selected role
  const role = document.getElementById('loginForm').dataset.role || 'voter';

  // redirect by role
  if(role === 'candidate'){
    window.location.href = 'candidate_page.html';
  }
  else if(role === 'voter'){
    window.location.href = 'voter_page.html';
  }
  else if(role === 'admin'){
    window.location.href = 'admin_panel.html';
  }
  else{
    window.location.href = 'guest_view.html';
  }
}

  

    function verifyOTP(){
      const entered = document.getElementById('otpInput').value.trim();
      const err = document.getElementById('error');
      err.style.display='none';
      if(!simulatedOTP){ err.style.display='block'; err.textContent='OTP মেয়াদ শেষ বা পাঠানো হয়নি।'; return; }
      if(entered.length === 0){ err.style.display='block'; err.textContent='OTP লিখুন।'; return; }

      // Accept if matches simulated OTP OR user typed the test OTP "123456"
      if(entered !== simulatedOTP && entered !== '123456'){
        err.style.display='block'; err.textContent='ভুল OTP — আবার চেক করুন।';
        return;
      }

      // success: stop timer, show verified modal and blur rest (overlay handles blur)
      clearInterval(otpTimer);
      document.getElementById('otpSuccess').style.display = 'block';

      // show modal overlay with Verified message
      openModal();
    }

    // init
    (function init(){
      regenCaptcha();
    })();
  </script>

  <!-- Auto-fill script: fills phone input if user just registered via signup.html -->
  <script>
    document.addEventListener('DOMContentLoaded', function(){
      try {
        const last = localStorage.getItem('last_registered_mobile');
        if(last){
          const phoneEl = document.getElementById('phone');
          if(phoneEl && !phoneEl.value){
            let v = last;
            // last is stored without +88 in signup flow; try to present with +88 prefix in login input
            if(!v.startsWith('+88')){
              if(v.length === 11 && v.startsWith('01')) v = '+88' + v;
              else if(v.length === 10 && v.startsWith('1')) v = '+88' + v;
              else if(v.length === 10 && v.startsWith('0')) v = '+88' + v;
            }
            phoneEl.value = v;
            // clear the stored helper to avoid autofill next time (optional)
            // localStorage.removeItem('last_registered_mobile');
          }
        }
      } catch(e){
        console.warn('Autofill error', e);
      }
    });
  </script>
</body>
</html>
