<!doctype html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sign Up — বাংলাদেশ নির্বাচন কমিশন</title>

  <style>
    :root {
      --green:#0b6a33;
      --green-light:#2fa14f;
      --muted:#4b6d5c;
    }
    * { box-sizing:border-box; }
    body {
      margin:0;
      font-family:"Noto Sans Bengali","Noto Sans",Arial,sans-serif;
      background:url("images/1123.jpg") center/cover fixed no-repeat;
      color:#07301f;
    }
    .overlay {
      background:rgba(255,255,255,0.86);
      min-height:100vh;
      padding:30px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .card {
      width:900px;
      max-width:96%;
      background:#fff;
      border-radius:16px;
      padding:26px 30px;
      box-shadow:0 30px 80px rgba(6,60,30,0.16);
      border:1px solid rgba(6,60,30,0.06);
    }
    .brand { display:flex;align-items:center;gap:14px; }
    .brand img { width:70px;height:70px;border-radius:8px;object-fit:cover; }
    h1 { margin:0;font-size:20px;color:var(--green);font-weight:900; }
    p.lead { margin:3px 0 12px;color:var(--muted);font-size:14px; }

    label{display:block;margin-top:12px;font-weight:800;color:#235038}
    input, select {
      width:100%;padding:12px;border-radius:10px;
      border:1px solid #ddeee1;background:#fff;font-size:15px;
      outline:none;margin-top:4px;
    }
    input:focus, select:focus { border-color:var(--green);box-shadow:0 10px 30px rgba(11,79,49,0.06); }

    .row { display:flex;gap:12px; }
    .col { flex:1; }

    .photo-preview {
      width:160px;height:200px;border-radius:10px;background:#eef7ef;
      border:2px dashed rgba(11,79,49,0.16);
      display:flex;align-items:center;justify-content:center;
      overflow:hidden;color:#7aa789;font-weight:700;margin-top:6px;
    }
    .photo-preview img { width:100%;height:100%;object-fit:cover; }

    .btn {
      padding:10px 15px;border-radius:10px;border:none;
      font-weight:800;cursor:pointer;font-size:15px;
    }
    .btn.primary {
      background:linear-gradient(180deg,var(--green-light),var(--green));
      color:#fff;
      box-shadow:0 14px 40px rgba(11,79,49,0.16);
    }
    .btn.ghost {
      background:transparent;
      border:1px solid rgba(11,79,49,0.18);
      color:var(--green);
    }

    .error { display:none;background:#fdecea;color:#a32626;padding:10px;border-radius:10px;border:1px solid #f3d0d0;margin-top:12px; }
    .success-box { display:none;background:#ebfff1;color:var(--green);padding:14px;border-radius:12px;margin-top:12px;border:1px solid rgba(11,79,49,0.12); }

    #cameraFeed, #captureCanvas { display:none; }

    @media(max-width:700px){
      .row { flex-direction:column; }
    }
  </style>
</head>

<body>
<div class="overlay">
  <div class="card">

    <div class="brand">
      <img src="images/Bangladesh_EC.jpg" alt="logo">
      <div>
        <h1>বাংলাদেশ নির্বাচন কমিশন</h1>
        <p class="lead">নতুন ভোটার রেজিস্ট্রেশন — Sign Up</p>
      </div>
    </div>

    <div id="errorBox" class="error"></div>
    <div id="successBox" class="success-box"></div>

    <form id="signupForm" onsubmit="return doSignup(event)" autocomplete="off">

      <div class="row">
        <div class="col">
          <label>Full Name (পূর্ণ নাম)</label>
          <input id="fullName" type="text" placeholder="তোমার নাম লিখো" required>
        </div>
        <div class="col">
          <label>Mobile (মোবাইল)</label>
          <input id="mobile" type="tel" placeholder="+8801xxxxxxxxx" required>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>Voter ID</label>
          <input id="voterId" type="text" placeholder="0112330403" required>
        </div>
        <div class="col">
          <label>Area / Address</label>
          <input id="area" type="text" placeholder="District, Bangladesh">
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>Date of Birth</label>
          <input id="dob" type="date" required>
        </div>
        <div class="col">
          <label>Gender</label>
          <select id="gender">
            <option value="">Select...</option>
            <option>Male</option><option>Female</option><option>Other</option>
          </select>
        </div>
      </div>

      <label>Email (optional)</label>
      <input id="email" type="email" placeholder="example@mail.com">

      <label>Upload Photo</label>
      <input id="photoInput" type="file" accept="image/*" style="display:none" onchange="previewPhoto(event)">
      <button type="button" class="btn ghost" onclick="document.getElementById('photoInput').click()">Choose Photo</button>
      <div class="photo-preview" id="photoPreview">PHOTO</div>

      <label style="margin-top:18px;font-weight:800;color:#0b6a33">
        Face Verification (একটি ক্লিকেই!)
      </label>

      <button type="button" id="faceBtn" class="btn primary" onclick="autoFaceVerify()">
        Verify Face
      </button>

      <div id="facePreview" class="photo-preview" style="width:240px;height:180px;margin-top:14px">
        No Face Captured
      </div>

      <div id="faceResult" style="margin-top:10px;font-weight:700;color:#b12727"></div>

      <div style="margin-top:16px;display:flex;gap:14px">
        <button id="registerBtn" class="btn primary" type="submit" disabled>Register — রেজিস্টার</button>
        <button type="button" class="btn ghost" onclick="window.location.href='index.html'">Back to Login</button>
      </div>

    </form>

    <video id="cameraFeed" width="240" height="180" autoplay playsinline></video>
    <canvas id="captureCanvas" width="240" height="180"></canvas>

  </div>
</div>

<script>
(function(){
  const d=new Date();
  const max=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  document.getElementById('dob').max=max;
})();

function showError(msg){
  const e=document.getElementById('errorBox');
  e.textContent=msg;
  e.style.display='block';
}

function showSuccess(msg){
  const s=document.getElementById('successBox');
  s.textContent=msg;
  s.style.display='block';
}

function previewPhoto(ev){
  const file=ev.target.files[0];
  if(!file) return;
  const reader=new FileReader();
  reader.onload=e=>{
    const p=document.getElementById('photoPreview');
    p.innerHTML=`<img src="${e.target.result}">`;
    p.dataset.photo=e.target.result;
  };
  reader.readAsDataURL(file);
}

// ==== FACE VERIFY — ONE BUTTON ====
let faceVerified=false;
let videoStream=null;

function autoFaceVerify(){
  const btn=document.getElementById("faceBtn");
  btn.disabled=true;
  btn.textContent="Verifying...";

  navigator.mediaDevices.getUserMedia({ video:{facingMode:"user"} })
    .then(stream=>{
      videoStream=stream;
      const video=document.getElementById("cameraFeed");
      video.srcObject=stream;
      video.onloadedmetadata=()=>{
        setTimeout(()=>{
          const canvas=document.getElementById("captureCanvas");
          const ctx=canvas.getContext("2d");
          ctx.drawImage(video,0,0,canvas.width,canvas.height);
          let snap=canvas.toDataURL("image/jpeg");

          document.getElementById("facePreview").innerHTML=
            `<img src="${snap}" style="width:100%;height:100%;object-fit:cover;border-radius:10px">`;

          faceVerified=true;
          document.getElementById("faceResult").style.color="#0b6a33";
          document.getElementById("faceResult").textContent="✔ Face Verified Successfully!";
          document.getElementById("registerBtn").disabled=false;

          if(videoStream){
            videoStream.getTracks().forEach(t=>t.stop());
          }

        },900);
      };
    })
    .catch(()=>{
      showError("Camera খুলতে সমস্যা হচ্ছে!");
      btn.disabled=false;
      btn.textContent="Verify Face";
    });
}

function getAge(d){
  let b=new Date(d), t=new Date();
  let age=t.getFullYear()-b.getFullYear();
  let m=t.getMonth()-b.getMonth();
  if(m<0||(m===0 && t.getDate()<b.getDate())) age--;
  return age;
}

function getVoters(){
  try{return JSON.parse(localStorage.getItem('registered_voters')||'{}');}
  catch(e){return{};}
}
function setVoters(v){ localStorage.setItem('registered_voters',JSON.stringify(v)); }

function doSignup(ev){
  ev.preventDefault();

  if(!faceVerified){ showError("Face Verification সম্পন্ন করুন।"); return false; }

  const name=document.getElementById("fullName").value.trim();
  const mobile=document.getElementById("mobile").value.trim();
  const voterId=document.getElementById("voterId").value.trim();
  const area=document.getElementById("area").value.trim();
  const dob=document.getElementById("dob").value.trim();
  const gender=document.getElementById("gender").value;
  const email=document.getElementById("email").value.trim();
  const photo=document.getElementById("photoPreview").dataset.photo||'';

  if(!name){showError("নাম লিখুন");return false;}
  if(!mobile){showError("মোবাইল দিন");return false;}
  if(getAge(dob)<18){showError("১৮ বছরের নিচে ভোটার রেজিস্টার করা যাবে না.");return false;}

  let voters=getVoters();
  let key=mobile.replace(/^\+?88/,'');
  if(voters[key]){ showError("এই মোবাইলে আগেই একাউন্ট আছে!"); return false; }

  voters[key]={
    name, mobile:key, voterId, area, dob, gender,
    email, photo,
    face_verified:true,
    created_at:new Date().toISOString()
  };
  setVoters(voters);

  showSuccess("Registration successful!");
  setTimeout(()=>window.location.href="index.html",1200);

  return false;
}
</script>
</body>
</html>
